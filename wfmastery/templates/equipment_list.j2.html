{% extends "template_body.j2.html" %}

{% block title%}{{origin.identity|title}} list{% endblock title%}
{%block head %}
{{ super() }}
<script type="text/javascript" src="../static/utility.js"></script>
<script type="text/javascript" src="../static/magic_columns.js"></script>

<style>

    * {
        z-index: 1;
    }

    body {
        margin: 0px;
    }

    .list {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        font-size: 1rem;
        padding-top: 9.8em;

    }



    .header {
        position: fixed;
        top: 3em;
        width: 100%;
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        background-color: rgba(255, 255, 255, 0.8);
        font-size: 1.4em;
        /*border-bottom: solid black thin;*/
        z-index: 10;
    }
    .subheader {
        position: fixed;
        top: 5em;
        width: 100%;
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        background-color: rgba(255, 255, 255, 0.8);
        font-size: 1.4em;
        border-bottom: solid black thin;
        z-index: 10;
    }

    .banner {
        position: fixed;
        top: -1em;
        width: 100%;
        height: 1em;
        text-align: center;
        padding: 1em;
        background-color: rgba(255, 255, 255, 0.9);
        z-index: 5;
    }

    .row {
        width: 100%;
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
    }



    .row:nth-child(even):not(.hide) {
        background-color: lightgray;
    }

    .hide {
        display: none !important;
    }

    .cell {
        flex-grow: 1;
        text-align: left;
        flex-flow: row nowrap;
        flex-basis: 0;
        padding: 0.5em;
        word-break: break-word;
    }

    .killbox {
        color: red;
        border: solid black thin;
        border-radius: 15px;
        padding: 1px;
        font-size: 1rem;
    }



    .small {
        width: 2em;
        flex-grow: .3;
    }


    .smartbox {
        position: fixed;

        background-color: white;
        border: outset gray medium;
        padding: 2px;
        z-index: 11;

    }

    .smartbox h1 {
        margin: 0 auto;
        text-align: center;

    }

    .smartbox button {
        float: right;
    }

    .smartbox input {
        margin: 0px 10px 2px 10px;
        padding: 5px;
    }

    .smartbox ul {
        list-style: none;
        margin: 0px 10px 2px 10px;
        padding: 5px;
    }

    .smartbox li {
        padding: 4px 10px;
        text-align: center;
        cursor: pointer;
        outline: none;
        box-shadow: 0 9px #e1e4ea;
        border: outset medium gray;
        border-radius: 15px;
        margin-bottom: 9px;

    }
    .smartbox li:hover {
        background-color: #c6c9ce
    }

    .smartbox  li.active {
        background-color: darkgreen;
        color:white;
        box-shadow: 0 3px black;
        /*transform: translateY(2px);*/
    }

    .smartbox li:active {
        background-color: darkgreen;
        box-shadow: 0 3px black;
        transform: translateY(2px);
    }

    .smartbox .hide {
        animation-duration: 5s;
        animation: fadeout;
    }

    @keyframes fadeout {
        from {
            color: rgba(0,0,0,1);
        }

        to {
            color: rgba(256,256,256,0);
            display: none;
        }
    }

</style>
{% endblock head %}
{% macro data_attributes(data_map, prefix="data-") -%}

    {%- for name, value in data_map.items() -%}
    {{" "}}{{prefix}}{{name}}="{{value}}"
    {%- endfor -%}
{%- endmacro %}

{% macro cell(name, value, classes=None, data_attrs={}) %}
        <span class="{{- ["cell",classes]|join(" ") if classes else "cell" -}}"{{data_attributes(data_attrs)}}>
    {{- caller() if caller else value -}}</span>
{%- endmacro -%}


{%- macro record_row(record, field_names) -%}
{%-     for field_name in field_names  -%}
        {{ cell(field_name, record[field_name], data_attrs=dict(name=field_name, value=record[field_name])) -}}
{%-     endfor -%}
        {{ caller() if caller -}}
{%- endmacro -%}

{%block content %}
<h1 class="banner">{{origin.identity|title}}</h1>
<div class="list">
    <div class="header">
{%-      for column_name in origin.list_columns -%}
{%-          if column_name in origin.magic_columns -%}
        {{ cell("", column_name|title, classes=origin.magic_columns[column_name]) -}}
{%-          else -%}
        {{ cell("", column_name|title) -}}
{%          endif %}
{%-      endfor %}
        <span class="cell magic-filter">Category</span>
        <span class="cell magic-filter">Subcategory</span>
        <span class="cell">Actions</span>
    </div>
    <div class="subheader">
{%-     for column_name in origin.list_columns -%}
        {{cell("","") -}}
{%      endfor %}
        <span class="cell"></span>
        <span class="cell"></span>
        <span class="cell"></span>
    </div>

{%-  for record in records %}
    <div class="row" data-record-id="{{record.id}}">
{%-      call record_row(record, origin.list_columns) -%}
        {{
        cell("category.name", record.category.name,
                data_attrs={
                   "name":"category.name",
                   "record-id":record.category.id,
                   "value":record.category.name
                }
            )
            -}}
        {{ cell("subcategory.name", record.subcategory.name,
                data_attrs={
                    "name":"subcategory.name",
                    "record-id":record.subcategory.id,
                    "value":record.subcategory.name
                }
            )

        -}}
        {% call cell("","") %}
            <a href="{{origin.base_url}}{{record.id}}">Edit</a>
        {% endcall -%}
{%      endcall %}
    </div>
{%-  endfor -%}
    <div class="tail">
        <span class="cell"></span>
        <span class="cell"></span>
        <span class="cell"></span>
        <span class="cell"></span>
        <span class="cell"></span>
        <span class="cell"></span>
        <span class="cell"></span>
    </div>
</div>


<script>


    var list_classes = {row:"row", cell:"cell", header_row:"header"};
    var list_element = document.getElementsByClassName("list")[0];

    function ApplyMagic(classes, list){
        //Find the headers
        let magic_map = {}
        let headers = list.querySelectorAll(`.${classes.header_row} .${classes.cell}`)
        let subheaders = list.querySelectorAll(`.subheader .${classes.cell}`)

        for(var i = 0; i < headers.length; i++){
            let contains = str=>headers[i].classList.contains(str);

            let name = headers[i].innerHTML;

            if(contains("magic-string")) {
                magic_map[name] = new StringColumn(
                    list, i+1, list_classes
                )
            }
            else if(contains("magic-filter")) {
                magic_map[name] = new FilterColumn(
                    list, i+1, list_classes
                )
            }


            let blank_fill = Array(name.length+1).fill("&nbsp;").join("");
            //for(let si = 0; si < name.length; si++){
            //    blank_fill += "&nbsp;"
            //}

            subheaders[i].innerHTML = blank_fill;




        }

        return magic_map;
    }


    djw(x=>ApplyMagic(list_classes, list_element));

</script>
{% endblock content %}
